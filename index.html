<html>

<head>
  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8">
  <script src="js/jquery-2.2.1.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="js/jstween-1.2.min.js" type="text/javascript" charset="utf-8"></script>

  <script type="text/javascript">
    var timestampOld;
    var timestamp;

    // Player 1 tag, score and character
    var pName1;
    var pScore1;
    var mText1;

    // Player 2 tag, score and character
    var pName2;
    var pScore2;
    var mText2;

    // Current round
    var mText3;

    // XML request
    var xmlDoc;
    var xhr = new XMLHttpRequest();

    // Animation flags
    var animating = false;
    var doUpdate = false;

    function init() {
      xhr.overrideMimeType('text/xml');

      var timeout = this.window.setInterval(function () {
        pollHandler();
      }, 250);

      $('#pName1').html('');
      $('#pScore1').html('');
      $('#mText1').data("character", "");
      $('#mText1').css("background-image", "url('')");

      $('#pName2').html('');
      $('#pScore2').html('');
      $('#mText2').data("character", "");
      $('#mText2').css("background-image", "url('')");

      $('#mText3').html('');

      $('#board').tween({
        top: {
          start: '-100',
          stop: '0',
          units: 'px',
          time: 0,
          duration: 0.8,
          effect: 'easeOut'
        }
      });

      $.play();
    }

    function pollHandler() {
      loadData();
      if (timestamp != timestampOld) {
        doUpdate = true;
      }
      if (!animating && doUpdate) {
        updateBoard();
      }
    }

    function loadData() {
      xhr.open('GET', 'streamcontrol.xml');
      xhr.send();
      xhr.onreadystatechange = function () {
        xmlDoc = xhr.responseXML;

        pName1 = getValueFromTag(xmlDoc, 'pName1');
        pScore1 = getValueFromTag(xmlDoc, 'pScore1');
        mText1 = getValueFromTag(xmlDoc, 'mText1');

        pName2 = getValueFromTag(xmlDoc, 'pName2');
        pScore2 = getValueFromTag(xmlDoc, 'pScore2');
        mText2 = getValueFromTag(xmlDoc, 'mText2');

        mText3 = getValueFromTag(xmlDoc, 'mText3');

        timestampOld = timestamp;
        timestamp = getValueFromTag(xmlDoc, 'timestamp');

      }
    }

    function updateBoard() {
      if ($('#pName1').html() != pName1) {
        animating = true;
        $('#pName1').tween({
          left: {
            start: 175,
            stop: 275,
            units: 'px',
            time: 0,
            duration: 0.5,
            effect: 'easeIn'
          },
          opacity: {
            start: 100,
            stop: 0,
            time: 0,
            duration: 0.5,
            effect: 'easeIn'
          },
          onStop: function () {
            $('#pName1').html(pName1);
          }
        });

        $('#pName1').tween({
          left: {
            start: 275,
            stop: 175,
            units: 'px',
            time: 0.5,
            duration: 0.5,
            effect: 'easeOut'
          },
          opacity: {
            start: 0,
            stop: 100,
            time: 0.5,
            duration: 0.5,
            effect: 'easeOut'
          },
          onStop: function () {
            animating = false;
          }
        });
      }

      if ($('#pName2').html() != pName2) {
        animating = true;
        $('#pName2').tween({
          left: {
            start: 775,
            stop: 675,
            units: 'px',
            time: 0,
            duration: 0.5,
            effect: 'easeIn'
          },
          opacity: {
            start: 100,
            stop: 0,
            time: 0,
            duration: 0.5,
            effect: 'easeIn'
          },
          onStop: function () {
            $('#pName2').html(pName2);
          }
        });

        $('#pName2').tween({
          left: {
            start: 675,
            stop: 775,
            units: 'px',
            time: 0.5,
            duration: 0.5,
            effect: 'easeOut'
          },
          opacity: {
            start: 0,
            stop: 100,
            time: 0.5,
            duration: 0.5,
            effect: 'easeOut'
          },
          onStop: function () {
            animating = false;
          }
        });
      }

      if ($('#pScore1').html() != pScore1) {
        animating = true;
        $('#pScore1').tween({
          opacity: {
            start: 100,
            stop: 0,
            time: 0,
            duration: 0.5,
            effect: 'easeIn'
          },
          onStop: function () {
            $('#pScore1').html(pScore1);
          }
        });

        $('#pScore1').tween({
          opacity: {
            start: 0,
            stop: 100,
            time: 0.5,
            duration: 0.5,
            effect: 'easeOut'
          },
          onStop: function () {
            animating = false;
          }
        });
      }

      if ($('#pScore2').html() != pScore2) {
        animating = true;
        $('#pScore2').tween({
          opacity: {
            start: 100,
            stop: 0,
            time: 0,
            duration: 0.5,
            effect: 'easeIn'
          },
          onStop: function () {
            $('#pScore2').html(pScore2);
          }
        });

        $('#pScore2').tween({
          opacity: {
            start: 0,
            stop: 100,
            time: 0.5,
            duration: 0.5,
            effect: 'easeOut'
          },
          onStop: function () {
            animating = false;
          }
        });
      }

      if ($('#mText1').data('character') != mText1) {
        animating = true;
        $('#mText1').tween({
          opacity: {
            start: 100,
            stop: 0,
            time: 0,
            duration: 0.5,
            effect: 'easeIn'
          },
          onStop: function () {
            $('#mText1').data('character', mText1);
            $('#mText1').css("background-image", "url('images/" + mText1 + ".png')");
          }
        });

        $('#mText1').tween({
          opacity: {
            start: 0,
            stop: 100,
            time: 0.5,
            duration: 0.5,
            effect: 'easeOut'
          },
          onStop: function () {
            animating = false;
          }
        });
      }

      if ($('#mText2').data('character') != mText2) {
        animating = true;
        $('#mText2').tween({
          opacity: {
            start: 100,
            stop: 0,
            time: 0,
            duration: 0.5,
            effect: 'easeIn'
          },
          onStop: function () {
            $('#mText2').data('character', mText2);
            $('#mText2').css("background-image", "url('images/" + mText2 + ".png')");
          }
        });

        $('#mText2').tween({
          opacity: {
            start: 0,
            stop: 100,
            time: 0.5,
            duration: 0.5,
            effect: 'easeOut'
          },
          onStop: function () {
            animating = false;
          }
        });
      }

      if ($('#mText3').html() != mText3) {
        animating = true;
        $('#mText3').tween({
          opacity: {
            start: 100,
            stop: 0,
            time: 0,
            duration: 0.5,
            effect: 'easeIn'
          },
          onStop: function () {
            $('#mText3').html(mText3);
          }
        });

        $('#mText3').tween({
          opacity: {
            start: 0,
            stop: 100,
            time: 0.5,
            duration: 0.5,
            effect: 'easeOut'
          },
          onStop: function () {
            animating = false;
          }
        });
      }

      $.play();

      doUpdate = false;
    }

    function getValueFromTag(xmlDoc, tag) {
      if (xmlDoc.getElementsByTagName(tag).length != 0) {
        if (xmlDoc.getElementsByTagName(tag)[0].childNodes.length == 0) {
          return '';
        } else {
          return xmlDoc.getElementsByTagName(tag)[0].childNodes[0].nodeValue;
        }
      } else {
        return '';
      }
    }
  </script>
</head>

<body onLoad="init()">
  <div id="board" class="board">
    <div class="player player--1">
      <div class="character-container">
        <div id="mText1" class="character" data-character=""></div>
      </div>
      <p id="pName1" class="tag">Player 1</p>
      <div class="score-container">
        <p id="pScore1" class="score">0</p>
      </div>
    </div>
    <div class="brand">
      <div class="left"></div>
      <div class="middle"></div>
      <div class="right"></div>
    </div>
    <div class="player player--2">
      <div class="score-container">
        <p id="pScore2" class="score">0</p>
      </div>
      <p id="pName2" class="tag">Player 2</p>
      <div class="character-container">
        <div id="mText2" class="character" data-character=""></div>
      </div>
    </div>
    <p id="mText3" class="round">Round</p>
  </div>
</body>

</html>